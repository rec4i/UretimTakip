@model WebIU.Models.StokViewModels.StokDüzenleViewModel

<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <label>Stok Kodu:</label>
                        <input type="text" id="StokKodu" class="form-control" value="@Model.Stok.StokKodu" />
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Stok Adı:</label>
                        <input type="text" id="StokAdı" class="form-control" value="@Model.Stok.StokAdı" />
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="DetayCheckBox">
                            <label class="form-check-label" for="DetayCheckBox">Detay Bilgi Girişi</label>
                        </div>
                    </div>
                </div>
                <div id="DetayDiv" hidden>
                    <div class="row">
                        <div class="col">
                            <label>Stok Birimi:</label>
                            <select id="BirimId" class="form-control">
                                @foreach (var item in Model.Birims)
                                {
                                    if (item.Id == Model.Stok.BirimId)
                                    {
                                        <option selected value="@item.Id">@item.BirimKodu (@item.DönüşümAçıklama)</option>
                                        continue;
                                    }
                                    <option value="@item.Id">@item.BirimKodu (@item.DönüşümAçıklama)</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Depo :</label>
                            <select id="DepoId" class="form-control" style="width:100%">
                                @foreach (var item in Model.Depos)
                                {
                                    if (item.Id == Model.Stok.DepoId)
                                    {
                                        <option selected value="@item.Id">@item.DepoAdı </option>
                                        continue;
                                    }
                                    <option value="@item.Id">@item.DepoAdı </option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Açıklama:</label>
                        <textarea id="Açıklama" class="form-control" rows="3">@Model.Stok.Açıklama</textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="card card-primary">
                            <div class="card-header">
                                <label>Fiyat Listesi</label>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-5">
                                        <label>Birim Fiyat:</label>
                                    </div>
                                    <div class="col-5">
                                        <label>Kdv Oranı:</label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-5">
                                        <input type="text" class="form-control" id="BirimFiyat" data-Mask="decimal" value="" />
                                    </div>
                                    <div class="col-5">
                                        <input type="text" class="form-control" id="KdvOranı" data-Mask="decimal" value="" />
                                    </div>
                                    <div class="col-2">
                                        <button class="btn btn-primary btn-block" id="FiyatKaydetBtn"><i class="fa fa-plus"></i> Ekle</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col">
                                                        <table id="OrderList"
                                                               data-toolbar="#OrderListToolBar"
                                                               data-pagination="true"
                                                               data-side-pagination="server"
                                                               data-id-field="id"
                                                               data-page-list="[10, 25, 50, 100, all]"
                                                               data-locale="Tr-tr"
                                                               data-search="true"
                                                               data-show-refresh="true"
                                                               data-show-export="true">
                                                            <thead>
                                                                <tr>
                                                                    <th data-field="id" data-title="id" hidden data-sortable="false"></th>
                                                                    <th data-field="geçerliFiyat" data-title="Birim Fiyat" data-sortable="false"></th>
                                                                    <th data-field="geçerliKdvOranı" data-title="Kdv Oranı" data-sortable="false"></th>
                                                                    <th data-title="Actions" data-sortable="false"></th>
                                                                </tr>
                                                            </thead>
                                                        </table>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <div class="card card-primary">
                            <div class="card-header">
                                <label>Fiyat Listesi</label>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-5">
                                        <label>Barkod </label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-10">
                                        <input type="text" class="form-control" id="Barkod" value="" />
                                    </div>
                                    <div class="col-2">
                                        <button class="btn btn-primary btn-block" id="BarkodEkle"><i class="fa fa-plus"></i> Ekle</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col">
                                                        <table id="BarkodTable"
                                                               data-toolbar="#BarkodTableToolBar"
                                                               data-pagination="true"
                                                               data-side-pagination="server"
                                                               data-id-field="id"
                                                               data-page-list="[10, 25, 50, 100, all]"
                                                               data-locale="Tr-tr"
                                                               data-search="true"
                                                               data-show-refresh="true"
                                                               data-show-export="true">
                                                            <thead>
                                                                <tr>
                                                                    <th data-field="id" data-title="id" hidden data-sortable="false"></th>
                                                                    <th data-field="İçerik" data-title="Barkod" data-sortable="false"></th>
                                                                    <th data-title="Actions" data-sortable="false"></th>
                                                                </tr>
                                                            </thead>
                                                        </table>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="d-flex flex-row-reverse">
                            <div class="p-2">
                                <button class="btn btn-warning" id="StokKaydetBtn"><i class="fa fa-save"></i> Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function () {
        $('#FiyatKaydetBtn').click(function () {
            var data = new FormData();
            data.append('Id', $(this).attr('StokId'))
            data.append('BirimFiyat', $('#BirimFiyat').val())
            data.append('KdvOranı', $('#KdvOranı').val())
            data.append('StokId', @Model.Stok.Id)

            $.ajax({
                url: "/Stok/FiyatEkle",
                type: "POST",
                processData: false,
                contentType: false,
                async: false,
                data: data,
                success: function (data) {
                    if (data.status == 1) {
                        successAlert(data.message)
                    }
                    else {
                        errorAlert(data.message)
                    }
                    OrderTablosuDoldur()
                },
            });


        })
        $('#BarkodEkle').click(function () {
            var data = new FormData();
            data.append('Id', $(this).attr('StokId'))
            data.append('Barkod', $('#Barkod').val())
            data.append('StokId', @Model.Stok.Id)

            $.ajax({
                url: "/Stok/BarkodEkle",
                type: "POST",
                processData: false,
                contentType: false,
                async: false,
                data: data,
                success: function (data) {
                    if (data.status == 1) {
                        successAlert(data.message)
                    }
                    else {
                        errorAlert(data.message)
                    }
                    BarkodTableDoldur()
                },
            });
        })

        $('#DetayCheckBox').click(function () {
            //DetayDiv
            if ($(this).is(':checked')) {
                $('#DetayDiv').removeAttr('hidden')
            }
            else {
                $('#DetayDiv').attr('hidden', 'true')
            }
        })

        OrderTablosuDoldur()
        BarkodTableDoldur()
    })
    function BarkodTableDoldur() {
        $('#BarkodTable').bootstrapTable("destroy")
        $('#BarkodTable').bootstrapTable({
            url: "/Stok/BarkodPagination?StokId=@Model.Stok.Id",
            columns: [
                [
                    {},
                    {},
                    {
                        formatter: ActionFormatter
                    },
                ]
            ],
            onLoadSuccess: afterLoad,
        })
        function ActionFormatter(value, row) {
            var value = "";
            value += "<button id='StokDüzenleModalAçBtn' StokId='" + row["id"] + "' class='btn btn-warning'><i class='fa fa-edit'></i> Düzenle</button>";
            value += "<button id='StokSil' StokId='" + row["id"] + "' class='btn btn-danger'><i class='fa fa-trash'></i></button>";
            value += "<a href='/Stok/Index?ÜstStokId=" + row["id"] + "&StokKoduHazır=" + row["stokKodu"] +"' StokId='" + row["id"] + "' class='btn btn-primary'><i class='fa fa-arrow-right'></i></a>";

            return value
        }
        function StokSay(value, row) {
            var ToplamStok = 0;
            console.log(row["stokHarekets"])
            for (var i = 0; i < row["stokHarekets"].length; i++) {
                //row["stokHarekets"][i].hareketTipi
                if (row["stokHarekets"][i].hareketTipi == 1) {
                    ToplamStok = ToplamStok + row["stokHarekets"][i].adet
                }
                if (row["stokHarekets"][i].hareketTipi == 2) {
                    ToplamStok = ToplamStok - row["stokHarekets"][i].adet
                }
            }
            return ToplamStok;
            //
        }
        function afterLoad() {
            $('*#StokSil').click(function () {

                var data = new FormData();
                data.append('Id', $(this).attr('StokId'))

                Swal.fire({
                    title: ' silinecektir!',
                    text: 'Silmek istediğinizden emin misiniz?',
                    icon: 'warning',
                    showCancelButton: true,
                    cancelButtonText: "Geri dön",
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sil'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "/Stok/StokSil",
                            type: "POST",
                            processData: false,
                            contentType: false,
                            async: false,
                            data: data,
                            success: function (data) {
                                if (data.status == 1) {
                                    successAlert(data.message)
                                }
                                else {
                                    errorAlert(data.message)
                                }
                                BarkodTableDoldur()
                            },
                        });
                    }
                })

            })


        }

    }

    function OrderTablosuDoldur() {
        $('#OrderList').bootstrapTable("destroy")
        $('#OrderList').bootstrapTable({
            url: "/Stok/GetFiyatPagination?StokId=@Model.Stok.Id",
            columns: [
                [
                    {},
                    {},
                    {},
                    {},
                    {
                        formatter: ActionFormatter
                    },
                ]
            ],
            onLoadSuccess: afterLoad,
        })
        function ActionFormatter(value, row) {
            var value = "";
            value += "<button id='StokDüzenleModalAçBtn' StokId='" + row["id"] + "' class='btn btn-warning'><i class='fa fa-edit'></i> Düzenle</button>";
            value += "<button id='StokSil' StokId='" + row["id"] + "' class='btn btn-danger'><i class='fa fa-trash'></i></button>";
            value += "<a href='/Stok/Index?ÜstStokId=" + row["id"] + "&StokKoduHazır=" + row["stokKodu"] +"' StokId='" + row["id"] + "' class='btn btn-primary'><i class='fa fa-arrow-right'></i></a>";

            return value
        }
        function StokSay(value, row) {
            var ToplamStok = 0;
            console.log(row["stokHarekets"])
            for (var i = 0; i < row["stokHarekets"].length; i++) {
                //row["stokHarekets"][i].hareketTipi
                if (row["stokHarekets"][i].hareketTipi == 1) {
                    ToplamStok = ToplamStok + row["stokHarekets"][i].adet
                }
                if (row["stokHarekets"][i].hareketTipi == 2) {
                    ToplamStok = ToplamStok - row["stokHarekets"][i].adet
                }
            }
            return ToplamStok;
            //
        }
        function afterLoad() {
            $('*#StokSil').click(function () {

                var data = new FormData();
                data.append('Id', $(this).attr('StokId'))

                Swal.fire({
                    title: ' silinecektir!',
                    text: 'Silmek istediğinizden emin misiniz?',
                    icon: 'warning',
                    showCancelButton: true,
                    cancelButtonText: "Geri dön",
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sil'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "/Stok/StokSil",
                            type: "POST",
                            processData: false,
                            contentType: false,
                            async: false,
                            data: data,
                            success: function (data) {
                                if (data.status == 1) {
                                    successAlert(data.message)
                                }
                                else {
                                    errorAlert(data.message)
                                }
                                OrderTablosuDoldur()
                            },
                        });
                    }
                })

            })

        }

    }


</script>